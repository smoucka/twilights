<!DOCTYPE html>
<html>
	<head>
		<title>3T</title>
		<style>
			.x.axis text {
				font: 10px sans-serif;
			}

			.x.axis path,
			.x.axis line {
				fill: none;
				shape_rendering: crispEdges;
			}

			.overlay {
				fill: none;
				pointer-events: all;
			}

			.focus rect {
				stroke: red;
				stroke-width: 3;
			}
		</style>
	</head>
	<body>
		<div id="map"></div>
		<div id="viz"></div>
		<div id="times"></div>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script type="text/javascript">
			
			var margin = {top:50, right:50, bottom:50, left:50},
				width = 830 - margin.left - margin.right,
				height = 300 - margin.top - margin.bottom;

			var yScale = d3.scale.linear()
				.domain([0,1440])
				.range([0,height]);

			var xScale = d3.time.scale()
				.domain([new Date(2017,0,0), new Date(2017,0,365)])
				.rangeRound([0,width]);
			/*
			// linear scale
			var xScale = d3.scale.linear()
				.domain([0,365])
				.rangeRound([0,width]);
			*/
			var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

			var bisectDate = d3.bisector(function(d) { return d.day; }).left;

			var xAxis = d3.svg
				.axis()
				.scale(xScale)
				//.orient("bottom")
				.ticks(months.length)
				//.tickValues(function(d, months) { return d.months; })
				.tickFormat(function(d, i) { return months[i] });

			var night_color = "black",
				a_color = "#0B3442",
				n_color = "#026789",
				c_color = "#63B4CF",
				s_color = "#FAFCB3";

			var svgViz = d3.select("#viz").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			svgViz.append("g")
				.attr("class", "x axis")
				.call(xAxis)
				.attr("transform", "translate(0, " + (-margin.top/2) + ")")
				.selectAll("text")
				.attr("x", width/months.length/2); // shift (center) month labels with response to varying width
			
			function dateFromDay(year, dayNum) {
				var date = new Date(year, 0); // initialize date and set year, YY-01-01
				return new Date(date.setDate(dayNum)); //add the rest of the date
			}

			function convertTime(in_time) {
				var minutes = parseInt(in_time.substring(0,2)) * 60 + parseInt(in_time.substring(2,4))
				return minutes
			}
			
			d3.csv("parsed_data/madison_times.csv", function(d, i) {
					return {
						day: dateFromDay(2017, i),
						a_beg: convertTime(d.astro_beg),
						n_beg: convertTime(d.naut_beg),
						c_beg: convertTime(d.civ_beg),
						s_beg: convertTime(d.rise),
						s_end: convertTime(d.set),
						c_end: convertTime(d.civ_end),
						n_end: convertTime(d.naut_end),
						a_end: convertTime(d.astro_end)
					};
				}, function(error, data) {
					draw(error, data);
				}
			);
			
			function draw(error, data) {

				data.sort(function(a, b) {
					return a.date - b.date;
				});

				bars = svgViz.selectAll("g.dayGroup")
					.data(data)
					.enter()
					.append("g")
					.attr("class", "dayGroup");

				bars.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", yScale(1440))
					.attr("transform", function(d) {
						return "translate(" + xScale(d.day) + ", 0)"
					})
					.style("fill", night_color);
				/*
				// rect calls in for...in loop
				var twilight_type_prefix = ['n', 'c', 's']

				for (var ttp in twilight_type_prefix) {
					bars.append("rect")
						.attr("width", function(d) {
							return xScale(concat(d, ".", ttp, "_end")) - xScale(concat(d, ".", ttp, "_beg"))
							//return concat('xScale(d.', ttp, '_end), yScale(d.day)')
						})
						.attr("height", yScale(1))
						.attr("transform", function(d) {
							return "translate(" + xScale(concat(d, ".", ttp, "_beg")) + ", " + yScale(d.day) + ")"
							//return concat('translate(xScale(d.', ttp, '_beg, yScale(d.day))')
							//return "translate(" + xScale(d.concat(ttp, '_beg')) + ", " + yScale(d.day) + ")"
						})
						.style("fill", concat(ttp, '_color)'));
				}
				*/
				// individual "rect" calls
				bars.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", function(d) {
						return yScale(d.a_end)-yScale(d.a_beg)
					})
					.attr("transform", function(d) {
						return "translate(" + xScale(d.day) + ", " + yScale(d.a_beg) + ")"
					})
					.style("fill", a_color);

				bars.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", function(d) {
						return yScale(d.n_end)-yScale(d.n_beg)
					})
					.attr("transform", function(d) {
						return "translate(" + xScale(d.day) + ", " + yScale(d.n_beg) + ")"
					})
					.style("fill", n_color);

				bars.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", function(d) {
						return yScale(d.c_end)-yScale(d.c_beg)
					})
					.attr("transform", function(d) {
						return "translate(" + xScale(d.day) + ", " + yScale(d.c_beg) + ")"
					})
					.style("fill", c_color);

				bars.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", function(d) {
						return yScale(d.s_end)-yScale(d.s_beg)
					})
					
					.attr("transform", function(d) {
						return "translate(" + xScale(d.day) + ", " + yScale(d.s_beg) + ")"
					})
					.style("fill", s_color);
				
				// g element in which to create bar that will highlight a day when mouseover,
				// will only display when cursor is within overlay rect
				var focus = svgViz.append("g")
					.attr("class", "focus")
					.style("display", "none");

				focus.append("rect")
					.attr("width", xScale(new Date(2017,0,1)))
					.attr("height", yScale(1440));

				svgViz.append("rect")
					.attr("class", "overlay")
					.attr("width", width)
					.attr("height", height)
					.on("mouseover", function() { focus.style("display", null); })
					.on("mouseout", function() { focus.style("display", "none"); })
					.on("mousemove", mousemove);

				function mousemove() {
					var x0 = xScale.invert(d3.mouse(this)[0]),
						//x0 = Math.floor(x/2)*2,
						//xDate = new Date(x0).toUTCString()
						i = bisectDate(data, x0, 1),	// what're the inputs here?
						d0 = data[i - 1],
						d1 = data[i],
						d = x0 - d0.day > d1.day - x0 ? d1 : d0;
					console.log(d)
					focus.attr("transform", "translate(" + xScale(d.day) + ", 0)");
				}
					
			}
			
		</script>
	</body>
</html>